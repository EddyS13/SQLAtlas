<UserControl x:Class="SQLAtlas.Views.IndexOptimizationView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:SQLAtlas.Converters" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="800">

    <UserControl.Resources>
        <local:ScriptToEnabledConverter x:Key="ScriptToEnabledConverter"/>
    </UserControl.Resources>

    <DockPanel Margin="10">

        <TextBlock DockPanel.Dock="Top" Margin="0,0,0,10" FontWeight="ExtraBold" FontSize="16"
                   Foreground="{StaticResource AccentColor}"
                   Text="Index Optimization Advisor (Comprehensive Report)"/>

        <Button Content="Refresh Index Analysis" 
                DockPanel.Dock="Top" Margin="0,0,0,10" Padding="5"
                x:Name="RefreshIndexButton" 
                Click="RefreshIndexButton_Click"/>

        <TextBlock x:Name="IndexStatusTextBlock" 
                   DockPanel.Dock="Top" Margin="0,5,0,5" 
                   Foreground="{StaticResource AccentColor}"
                   FontStyle="Italic" Text="Ready for analysis."/>

        <ScrollViewer VerticalScrollBarVisibility="Auto">
            <StackPanel>

                <TextBlock FontWeight="Bold" FontSize="14" Margin="0,10,0,5"
                           Foreground="{StaticResource AccentColor}"
                           Text="All Indexes and Fragmentation Status"/>

                <DataGrid x:Name="FragmentedIndexDataGrid" 
                          AutoGenerateColumns="False" 
                          HeadersVisibility="Column"
                          CanUserAddRows="False">

                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Schema.Table" Binding="{Binding SchemaTableName}" Width="1.5*" CanUserSort="True"/>
                        <DataGridTextColumn Header="Index Name" Binding="{Binding IndexName}" Width="1.5*" CanUserSort="True"/>
                        <DataGridTextColumn Header="Frag (%)" Binding="{Binding FragmentationPercent, StringFormat={}{0:F2} %}" Width="80" CanUserSort="True"/>
                        <DataGridTextColumn Header="Pages" Binding="{Binding PageCount, StringFormat={}{0:N0}}" Width="80" CanUserSort="True"/>
                        <DataGridTextColumn Header="Action Required" Binding="{Binding MaintenanceAction}" Width="100" CanUserSort="True"/>

                        <DataGridTemplateColumn Header="Execute DDL" Width="140">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Button Content="Execute Repair" 
                                            Click="MaintenanceActionButton_Click" 
                                            CommandParameter="{Binding MaintenanceScript}" 
                                            IsEnabled="{Binding MaintenanceScript, Converter={StaticResource ScriptToEnabledConverter}}"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>

                <TextBlock DockPanel.Dock="Bottom" Margin="0,10,0,0" FontStyle="Italic" TextWrapping="Wrap"
                           Text="Note: Only indexes with page_count > 8 are included in the maintenance recommendation logic."/>

            </StackPanel>
        </ScrollViewer>

    </DockPanel>
</UserControl>